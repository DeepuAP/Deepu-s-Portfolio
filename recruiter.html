<style>
    /* --- UI STYLES --- */
    .recruiter-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 1rem;
    }

    .recruiter-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

    .recruiter-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #CBD5E1;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    input:checked+.slider {
        background-color: #3B82F6;
    }

    input:checked+.slider:before {
        transform: translateX(24px);
    }

    .toggle-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* --- CHAT LAUNCHER --- */
    #chat-launcher {
        display: none;
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: #3B82F6;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        z-index: 2147483647 !important;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        transition: transform 0.3s ease;
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #chat-launcher:hover {
        transform: scale(1.1);
    }

    #chat-launcher .fa-arrow-up {
        transition: transform 0.3s ease;
    }

    #chat-launcher:hover .fa-arrow-up {
        transform: translateY(-3px);
    }

    /* --- CHAT WIDGET --- */
    #ai-chat-widget {
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 550px;
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        z-index: 999999;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #E2E8F0;
        font-family: 'Inter', sans-serif;
        animation: slideUp 0.3s ease-out;
        cursor: auto !important;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes popIn {
        from {
            transform: scale(0);
        }

        to {
            transform: scale(1);
        }
    }

    /* --- HEADER --- */
    .chat-header {
        background: linear-gradient(135deg, #3B82F6, #2563EB);
        padding: 15px 20px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .agent-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #3B82F6;
        font-size: 1rem;
    }

    .header-info h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
    }

    .header-status {
        font-size: 0.75rem;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: #10B981;
        border-radius: 50%;
    }

    .close-chat-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .close-chat-btn:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    /* --- BODY --- */
    .chat-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #F8FAFC;
        display: flex;
        flex-direction: column;
        gap: 15px;
        cursor: auto !important;
    }

    .message {
        max-width: 85%;
        padding: 12px 16px;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
        cursor: auto !important;
    }

    .message.bot {
        align-self: flex-start;
        background: white;
        color: #334155;
        border-radius: 12px 12px 12px 2px;
        border: 1px solid #E2E8F0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .message.user {
        align-self: flex-end;
        background: #3B82F6;
        color: white;
        border-radius: 12px 12px 2px 12px;
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
    }

    /* --- INPUT --- */
    .chat-input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #E2E8F0;
        display: flex;
        gap: 8px;
        align-items: center;
        cursor: auto !important;
    }

    #chat-input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #E2E8F0;
        border-radius: 20px;
        outline: none;
        font-size: 0.9rem;
        transition: border-color 0.3s;
        cursor: text !important;
    }

    #chat-input:focus {
        border-color: #3B82F6;
    }

    .icon-btn {
        width: 38px;
        height: 38px;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mic-btn {
        background: #F1F5F9;
        color: #64748B;
    }

    .mic-btn:hover {
        background: #E2E8F0;
        color: #3B82F6;
    }

    .mic-btn.active {
        background: #FEE2E2;
        color: #EF4444;
        animation: pulseRed 1.5s infinite;
    }

    .send-btn {
        background: #3B82F6;
        color: white;
    }

    .send-btn:hover {
        background: #2563EB;
        transform: scale(1.05);
    }

    @keyframes pulseRed {
        0% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
    }

    /* --- TYPING --- */
    .typing-indicator {
        display: none;
        align-self: flex-start;
        background: white;
        padding: 10px 15px;
        border-radius: 12px;
        gap: 4px;
        border: 1px solid #E2E8F0;
        cursor: auto !important;
    }

    .dot {
        width: 6px;
        height: 6px;
        background: #94A3B8;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* --- HIGHLIGHT ANIMATION --- */
    @keyframes ai-glow {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            border-color: #3B82F6;
            transform: scale(1);
        }

        50% {
            box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0);
            border-color: #3B82F6;
            transform: scale(1.05);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            border-color: #E2E8F0;
            transform: scale(1);
        }
    }

    .ai-highlight {
        animation: ai-glow 2s ease-in-out;
        z-index: 100 !important;
        position: relative;
    }

    /* --- SUGGESTIONS & TOOLTIPS --- */
    .suggestions-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        padding-left: 5px;
        cursor: auto !important;
    }

    .suggestion-btn {
        background: #F1F5F9;
        border: 1px solid #E2E8F0;
        border-radius: 20px;
        padding: 8px 12px;
        font-size: 0.8rem;
        color: #334155;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        flex: 1 1 auto;
    }

    .suggestion-btn:hover {
        background: #E0F2FE;
        border-color: #3B82F6;
        color: #0284C7;
    }

    /* --- VOICE TOOLTIP --- */
    .voice-tooltip {
        position: absolute;
        bottom: 70px;
        left: 10px;
        background: #1e293b;
        color: white;
        padding: 10px 15px;
        border-radius: 12px;
        font-size: 0.85rem;
        width: 220px;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        line-height: 1.4;
    }

    .voice-tooltip.visible {
        opacity: 1;
    }

    .voice-tooltip::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 20px;
        width: 12px;
        height: 12px;
        background: #1e293b;
        transform: rotate(45deg);
    }
</style>

<div id="chat-launcher" onclick="openRecruiterAgent()">
    <i class="fas fa-robot"></i>
</div>

<div id="ai-chat-widget">
    <div class="chat-header">
        <div class="header-left">
            <div class="agent-avatar"><i class="fas fa-bolt"></i></div>
            <div class="header-info">
                <h3>Deepak's Agent</h3>
                <div class="header-status"><span class="status-dot"></span>Online</div>
            </div>
        </div>
        <button class="close-chat-btn" onclick="minimizeChat()">Ã—</button>
    </div>

    <div class="chat-body" id="chat-body">
        <div class="message bot">
            ðŸ‘‹ Hi! I'm Deepak's AI Agent.<br><br>
            I have full access to his <strong>live project data</strong>. <br><br>
            Try asking:<br>
            â€¢ "Explain his <strong>projects</strong> in short"<br>
            â€¢ "What challenges did he face?"<br>
            â€¢ "Show his <strong>Education</strong>"
        </div>

        <!-- Suggestions Grid -->
        <div class="suggestions-grid">
            <button class="suggestion-btn" onclick="sendSuggestion('What kind of developer is Deepak?')">What kind of
                developer is Deepak?</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Explain his projects in simple terms')">Explain his
                projects in simple terms</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Is he suitable for a fresher role?')">Is he suitable
                for a fresher role?</button>
            <button class="suggestion-btn" onclick="sendSuggestion('What tools and technologies does he use?')">What
                tools and technologies does he use?</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Show his education details')">Show his education
                details</button>
            <button class="suggestion-btn" onclick="sendSuggestion('How can I contact him?')">How can I contact
                him?</button>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <div class="chat-input-area">
        <div class="voice-tooltip" id="voice-tooltip">
            ðŸŽ¤ <strong>Voice enabled</strong> <br>
            Powered by Deepgram API for seamless voice interaction.
        </div>
        <button class="icon-btn mic-btn" id="mic-btn"><i class="fas fa-microphone"></i></button>
        <input type="text" id="chat-input" placeholder="Type or speak..." autocomplete="off">
        <button class="icon-btn send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- 1. CONFIGURATION ---
        const GEMINI_API_KEY = '{{GEMINI_API_KEY}}';
        const DEEPGRAM_API_KEY = '{{DEEPGRAM_API_KEY}}';

        console.log("Gemini Key Status:", GEMINI_API_KEY.includes('REPLACE_ME') ? "âŒ Not Injected" : "âœ… Injected");

        // Singleton Check
        if (window.recruiterScriptInitialized) return;
        window.recruiterScriptInitialized = true;

        // --- DOM ELEMENTS (Safe Access) ---
        const widget = document.getElementById('ai-chat-widget');
        const launcher = document.getElementById('chat-launcher');
        const chatInput = document.getElementById('chat-input');
        const chatBody = document.getElementById('chat-body');
        const micBtn = document.getElementById('mic-btn');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const toggle = document.getElementById('recruiter-toggle');

        if (!widget || !launcher || !chatInput || !chatBody) {
            console.warn("Recruiter AI: Critical elements missing. Widget disabled.");
            return;
        }

        let isRecruiterMode = false;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let hasShownVoiceInSession = false; // In-memory session tracking

        // --- 2. DYNAMIC CONTEXT ---
        function getLiveProjectData() {
            if (window.projectsData && window.projectsData.length > 0) {
                let context = "\n\nCURRENT LIVE PROJECTS:\n";
                window.projectsData.forEach((p, index) => {
                    context += `[Project ID: ${index}]\nTitle: ${p.title}\nDesc: ${p.description}\nTech: ${p.stack}\nDetails: ${p.challenge}\n---\n`;
                });
                return context;
            }
            return "\n\n(No live project data loaded.)\n";
        }

        // --- 3. THE BRAIN ---
        function getFullContext() {
            return `
            You are 'Deepak's AI Bot'.
            NAME: Loga Deepak A.P
            ROLE: Fresher Full-Stack Developer
            TONE: Helpful, brief, professional.
            
            GOAL: Help recruiters check if he fits a role in < 1 minute.
            
            RULES:
            1. Keep answers SHORT (under 3 sentences).
            2. If asked "explain projects", use action: 'tour_projects'.
            3. If asked for "contact", use action: 'scroll_to' target 'contact'.
            
            CONTEXT:
            ${getLiveProjectData()}
            `;
        }

        // --- 4. GEMINI API (Safe & Friendly) ---
        async function getGeminiResponse(userText) {
            try {
                if (!GEMINI_API_KEY || GEMINI_API_KEY.includes('{{')) {
                    console.error("API Key Check Failed:", GEMINI_API_KEY);
                    throw new Error("API configuration missing");
                }

                // FIXED: Use v1beta gemini-2.5-flash (stable)
                // FIXED: Use v1beta gemini-1.5-flash (stable)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

                // Simplified Payload
                const systemPrompt = `${getFullContext()}\nIMPORTANT: Output strictly valid JSON. Format: { "reply": "text", "action": "...", "target": "..." }`;

                const payload = {
                    "contents": [{
                        "parts": [{ "text": systemPrompt + "\n\nUser Question: " + userText }]
                    }],
                    "generationConfig": { "response_mime_type": "application/json" }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Gemini API Error Detail:", response.status, response.statusText, errorText);
                    throw new Error(`API Failure: ${response.status} ${errorText}`);
                }

                const data = await response.json();
                if (!data.candidates?.length) throw new Error("No candidates received");

                let jsonText = data.candidates[0].content.parts[0].text;
                // Clean markdown code blocks if present
                jsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();

                return JSON.parse(jsonText);

            } catch (error) {
                console.error("AI Logic Error:", error);
                return {
                    "reply": "I'm having a connection issue. I've logged the error to the console.",
                    "action": "none"
                };
            }
        }

        // --- 5. CORE LOGIC ---
        window.openRecruiterAgent = function () {
            if (!isRecruiterMode) return;
            widget.style.display = 'flex';
            launcher.style.display = 'none';
            chatInput.focus();

            // Voice Tooltip (Once per session)
            const voiceTooltip = document.getElementById('voice-tooltip');
            if (voiceTooltip && !hasShownVoiceInSession) {
                setTimeout(() => {
                    voiceTooltip.classList.add('visible');
                    hasShownVoiceInSession = true;
                    setTimeout(() => voiceTooltip.classList.remove('visible'), 5000);
                }, 1000);
            }
        };

        window.minimizeChat = function () {
            widget.style.display = 'none';
            if (isRecruiterMode) launcher.style.display = 'flex';
        };

        async function handleUserMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            chatInput.value = '';
            typingIndicator.style.display = 'flex';
            chatBody.scrollTop = chatBody.scrollHeight;

            const decision = await getGeminiResponse(text);

            typingIndicator.style.display = 'none';
            appendMessage(decision.reply, 'bot');

            if (decision.action && decision.action !== 'none') {
                executeUIAction(decision.action, decision.target);
            }
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = text;
            chatBody.insertBefore(div, typingIndicator);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Suggestion Global Helper
        window.sendSuggestion = function (text) {
            chatInput.value = text;
            handleUserMessage();
        };

        // Suggestion Global Helper
        window.sendSuggestion = function (text) {
            chatInput.value = text;
            handleUserMessage();
        };

        // --- 6. ACTION EXECUTOR (Safe) ---
        function executeUIAction(action, target) {
            console.log(`Action: ${action}`);
            try {
                if (action === 'scroll_to' && target) {
                    const el = document.getElementById(target);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                if (action === 'tour_projects') {
                    // Simple scroll to active section
                    document.getElementById('projects')?.scrollIntoView({ behavior: 'smooth' });
                    setTimeout(() => window.openModal?.(0), 1000);
                }
                if (action.startsWith('open_project_modal_')) {
                    const idx = parseInt(action.split('_').pop());
                    window.openModal?.(idx);
                }
            } catch (err) {
                console.log("UI Action skipped safely.");
            }
        }

        // --- 7. EVENT LISTENERS ---
        if (toggle) {
            // Restore State on Load
            const savedState = localStorage.getItem('recruiterModeActive') === 'true';
            if (savedState) {
                toggle.checked = true;
                isRecruiterMode = true;
                launcher.innerHTML = '<i class="fas fa-robot"></i>';
                setTimeout(openRecruiterAgent, 600);
            }

            toggle.addEventListener('change', (e) => {
                isRecruiterMode = e.target.checked;
                localStorage.setItem('recruiterModeActive', isRecruiterMode);

                if (isRecruiterMode) {
                    launcher.innerHTML = '<i class="fas fa-robot"></i>';
                    openRecruiterAgent();
                } else {
                    widget.style.display = 'none';
                    launcher.style.display = 'none';
                }
            });
        }

        if (sendBtn) sendBtn.addEventListener('click', handleUserMessage);
        if (chatInput) chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserMessage();
        });

        // --- 8. AUDIO (Deepgram) ---
        if (micBtn) {
            micBtn.addEventListener('click', () => {
                if (!isRecording) startRecording();
                else stopRecording();
            });
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];
                    chatInput.placeholder = "Processing...";
                    await sendToDeepgram(blob);
                    chatInput.placeholder = "Type or speak...";
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                micBtn.classList.add('active');
            } catch (e) {
                alert("Microphone access denied. Please enable permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false;
            micBtn.classList.remove('active');
        }

        async function sendToDeepgram(blob) {
            if (!DEEPGRAM_API_KEY || DEEPGRAM_API_KEY.includes('{{')) return;
            try {
                const res = await fetch('https://api.deepgram.com/v1/listen?model=nova-2&smart_format=true', {
                    method: 'POST',
                    headers: { 'Authorization': `Token ${DEEPGRAM_API_KEY}`, 'Content-Type': 'audio/webm' },
                    body: blob
                });
                const data = await res.json();
                const transcript = data.results?.channels[0]?.alternatives[0]?.transcript;
                if (transcript) {
                    chatInput.value = transcript;
                    handleUserMessage();
                }
            } catch (e) {
                chatInput.placeholder = "Voice failed. Try typing.";
            }
        }
    });
</script>